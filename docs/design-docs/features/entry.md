# 概要

エントリー機能を作成する.

# 対象範囲

## 達成基準

- エントリーの各種操作を行うAPIが実装されている状態

## 除外項目

- ボリューム機能は対応しない
- 認可機能は対応しない

# 利用方法

## エンドポイント

| パス | メソッド | 備考 |
| --- | --- | --- |
| /entries/:volumeName | POST | エントリー作成 |
| /entries/:volumeName | GET | エントリー一覧取得 |
| /entries/:volumeName/:key | POST | エントリーコピー |
| /entries/:volumeName/:key | PUT | エントリー更新 |
| /entries/:volumeName/:key | DELETE | エントリー削除 |
| /entries/:volumeName/:key | HEAD | エントリー情報取得 |
| /entries/:volumeName/:key | GET | エントリー単体取得 |

# 詳細設計

## 要件

- ボリューム名とキー、ボディを入力しエントリーの作成を行える
- エントリーのコピーが行える
- キーの更新が行える
- エントリーの削除が行える
- エントリーの一覧, 単体取得が行える
  - ボリュームの公開フラグが立っている場合は単体取得を認証なしで行える

## 仕様

- ボディがないエントリーはフォルダとする
- キーはグローバルに一意
  - ボリュームIDとキーの組み合わせでグローバルに一意となる
- キーは1文字以上512文字以下かつ\\/:*?"<>|及び全角は利用不可
  - キーに含まれる各々のエントリー名は255文字以下
- エントリー作成時にファイルシステムにファイルまたはフォルダを作成する
- エントリーコピー時にファイルシステムにファイルまたはフォルダを作成する
- エントリー更新時にファイルシステムのファイルまたはフォルダを更新する
- エントリー削除時にファイルシステムのファイルまたはフォルダを削除する
- エントリー作成時及び更新時に上位エントリーが存在しない場合は生成する
- エントリー更新時に下位エントリーが存在する場合は更新する
- エントリー削除時に下位エントリーが存在する場合は削除する
- エントリーコピー時にkeyにcopyを追加する
  - copyを追加したキーが存在する場合は再度copyを追加する

## ドメインオブジェクト

### Entry

| キー | 型 | 備考 |
| --- | --- | --- |
| ID | uuid.UUID | |
| AccountID | uuid.UUID | |
| VolumeID | uuiid.UUID | |
| Key | string | 1文字以上512文字以下<br />\\:*?"<>\|及び全角は利用不可 |
| Size | uint64 | |
| Type | string | MIMEタイプまたはFolder |
| CreatedAt | time.Time | |
| UpdatedAt | time.Time | |

## テーブル

| カラム名 | 型 | キー | null許容 | 備考 |
| --- | --- | --- | --- | --- |
| id | char(36) | PK | | ID |
| account_id | char(36) | | | アカウントID |
| volume_id | char(36) | FK | | ボリュームID |
| key | varchar(255) | | | キー |
| size | bigint unsigned | | | サイズ |
| type | varchar(255) | | | タイプ |
| created_at | datetime(6) | | | 作成日時 |
| updated_at | datetime(6) | | | 更新日時 |

## テスト項目

| 項目 | 内容 |
| --- | --- |
| エントリーの初期化 | ドメインオブジェクトの初期化を確認 |
| キーの有効値判定 | 有効値と無効値の判定<br />文字数の境界値判定 |
| キーの重複判定 | キー重複時の判定 |
| 上位エントリー作成 | 作成及び更新時に上位エントリーが作成されるか確認 |
| 下位エントリー更新 | 更新時に下位エントリーが更新されるか確認 |
| 下位エントリー削除 | 削除時に下位エントリーが削除されるか確認 |
| 実行されるSQL | インフラ層で実行されるSQLの確認 |
| 実行される関数 | 実行される下位レイヤの関数を確認 |
| 戻り値 | 関数の戻り値を確認 |
| エラーハンドリング | エラー発生時のハンドリングを確認 |

# その他の手法

# 参考文献

# 変更履歴

| 変更日 | 変更者 | 変更内容 |
| --- | --- | --- |
| 2025/04/26 | @atsumarukun | 初版 |
| 2025/08/18 | @atsumarukun | キーの文字制限を更新 |
| 2025/08/18 | @atsumarukun | エントリー作成エンドポイントを変更 |
